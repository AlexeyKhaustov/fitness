{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ video.title }} - FitnessVideo{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Хлебные крошки -->
    <nav class="mb-6 text-sm text-gray-400">
        <a href="/" class="hover:text-purple-400">Главная</a>
        {% for cat in video.categories.all %}
            <span class="mx-2">/</span>
            <a href="{{ cat.get_absolute_url }}" class="hover:text-purple-400">{{ cat.name }}</a>
        {% endfor %}
        <span class="mx-2">/</span>
        <span class="text-white">{{ video.title|truncatechars:30 }}</span>
    </nav>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Основной контент -->
        <div class="lg:w-2/3">
            <!-- Видеоплеер с блокировкой для неподписанных -->
            <div class="bg-black rounded-2xl overflow-hidden shadow-2xl mb-6 relative">
                <div class="aspect-video">
                    {% if not video.is_free and not user_profile.subscription_active %}
                        <!-- БЛОКИРОВАННОЕ ВИДЕО -->
                        <div class="relative w-full h-full">
                            <!-- Blur эффект поверх видео -->
                            <video
                                id="main-video"
                                class="w-full h-full filter blur-lg opacity-70"
                                preload="metadata"
                                poster="{% if video.thumbnail %}{{ video.thumbnail.url }}{% endif %}"
                                onclick="showSubscribeModal()"
                            >
                                <source src="{{ video.file.url }}" type="video/mp4">
                                Ваш браузер не поддерживает видео.
                            </video>

                            <!-- Оверлей с призывом к подписке -->
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-white p-8 text-center">
                                <div class="mb-6">
                                    <i class="fa-solid fa-lock text-6xl text-purple-400 mb-4"></i>
                                    <h3 class="text-3xl font-bold mb-2">Премиум контент</h3>
                                    <p class="text-gray-300 text-lg">Это видео доступно только по подписке</p>
                                </div>

                                <div class="bg-gradient-to-r from-purple-900/80 to-pink-900/80 backdrop-blur-sm rounded-2xl p-8 max-w-md w-full">
                                    <h4 class="text-2xl font-bold mb-4">Получите доступ сейчас</h4>
                                    <ul class="space-y-3 mb-6 text-left">
                                        <li class="flex items-center">
                                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                                            <span>К этому и 1000+ других видео</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                                            <span>Безлимитный доступ ко всем категориям</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                                            <span>Персональные программы тренировок</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                                            <span>Отмена в любой момент</span>
                                        </li>
                                    </ul>
                                    <button onclick="showSubscribeModal()"
                                            class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-4 rounded-xl text-lg transition-all hover:scale-105 shadow-lg">
                                        Разблокировать за 299₽/месяц
                                    </button>
                                    <p class="text-gray-300 text-sm mt-4">Нажмите в любом месте плеера для продолжения</p>
                                </div>
                            </div>

                            <!-- Кнопка "воспроизвести" поверх блюра -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <button onclick="showSubscribeModal()"
                                        class="bg-purple-600 hover:bg-purple-700 text-white p-6 rounded-full transition-all hover:scale-110 shadow-2xl">
                                    <i class="fa-solid fa-play text-4xl"></i>
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <!-- ОТКРЫТОЕ ВИДЕО -->
                        <video
                            id="main-video"
                            class="w-full h-full"
                            controls
                            preload="metadata"
                            poster="{% if video.thumbnail %}{{ video.thumbnail.url }}{% endif %}"
                        >
                            <source src="{{ video.file.url }}" type="video/mp4">
                            Ваш браузер не поддерживает видео.
                        </video>
                    {% endif %}
                </div>

                {% if not video.is_free and user_profile.subscription_active %}
                    <div class="bg-gradient-to-r from-green-900 to-emerald-900 p-4 flex items-center">
                        <div class="flex items-center">
                            <i class="fa-solid fa-crown text-yellow-400 text-xl mr-3"></i>
                            <div>
                                <p class="text-white font-semibold">Премиум видео</p>
                                <p class="text-gray-300 text-sm">Доступ открыт по вашей подписке</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Информация о видео -->
            <div class="bg-gray-800 rounded-2xl p-6 shadow-xl mb-6">
                <div class="flex flex-col md:flex-row md:items-start justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-3">{{ video.title }}</h1>
                        <div class="flex flex-wrap gap-3 mb-4">
                            {% for cat in video.categories.all %}
                                <a href="{{ cat.get_absolute_url }}"
                                   class="px-4 py-2 rounded-full text-sm font-medium {{ cat.color }} hover:opacity-90 transition-opacity">
                                    <i class="fa-solid fa-{{ cat.icon }} mr-2"></i>
                                    {{ cat.name }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="flex items-center space-x-4 mt-4 md:mt-0">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-white">{{ video.views }}</div>
                            <div class="text-gray-400 text-sm">просмотров</div>
                        </div>
<!--                        Лайк-->
                        <button onclick="toggleLike({{ video.id }})"
                                id="like-button-header"
                                class="p-3 rounded-full transition-colors {% if user_liked %}bg-pink-600 hover:bg-pink-700{% else %}bg-gray-700 hover:bg-gray-600{% endif %}">
                            <i class="{% if user_liked %}fa-solid{% else %}fa-regular{% endif %} fa-heart text-xl"></i>
                        </button>
<!--                        Поделиться-->
                        <button onclick="shareVideo()"
                                class="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition-colors">
                            <i class="fa-solid fa-share text-xl"></i>
                        </button>
                    </div>
                </div>

                <div class="prose prose-invert max-w-none">
                    <h3 class="text-xl font-semibold text-white mb-4">Описание</h3>
                    <p class="text-gray-300 whitespace-pre-line">{{ video.description }}</p>
                </div>
            </div>
        </div>

        <!-- Боковая панель -->
        <div class="lg:w-1/3">
            <!-- Похожие видео -->
            {% if similar_videos %}
                <div class="bg-gray-800 rounded-2xl p-6 shadow-xl mb-6">
                    <h2 class="text-xl font-bold text-white mb-4">Похожие видео</h2>
                    <div class="space-y-4">
                        {% for similar in similar_videos %}
                            <a href="{% url 'video_detail' similar.id %}"
                               class="flex items-center bg-gray-900 hover:bg-gray-700 rounded-xl p-3 transition-colors group">
                                <div class="relative w-24 h-16 flex-shrink-0 rounded overflow-hidden">
                                    {% if similar.thumbnail %}
                                        <img src="{{ similar.thumbnail.url }}"
                                             alt="{{ similar.title }}"
                                             class="w-full h-full object-cover group-hover:scale-105 transition-transform">
                                    {% else %}
                                        <div class="w-full h-full bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center">
                                            <i class="fa-solid fa-play text-gray-600"></i>
                                        </div>
                                    {% endif %}
                                    {% if not similar.is_free %}
                                        <div class="absolute top-1 right-1 bg-gradient-to-br from-purple-600 to-pink-600 text-white text-xs px-2 py-0.5 rounded">
                                            PREM
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="ml-4">
                                    <h4 class="font-medium text-white group-hover:text-purple-400 line-clamp-2">{{ similar.title }}</h4>
                                    <div class="flex items-center text-gray-400 text-sm mt-1">
                                        <span>{{ similar.get_duration_display }}</span>
                                        <span class="mx-2">•</span>
                                        <span>{{ similar.views }} просмотров</span>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Информация о подписке (всегда показываем, если нет активной подписки) -->
            {% if not user_profile.subscription_active %}
                <div class="bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 rounded-2xl p-6 shadow-xl">
                    <h3 class="text-xl font-bold text-white mb-3">Откройте полный доступ</h3>
                    <p class="text-gray-200 mb-4">Подписка включает:</p>
                    <ul class="space-y-2 mb-6">
                        <li class="flex items-center text-gray-200">
                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                            <span>Все премиум видео</span>
                        </li>
                        <li class="flex items-center text-gray-200">
                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                            <span>Без рекламы</span>
                        </li>
                        <li class="flex items-center text-gray-200">
                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                            <span>Скачивание видео</span>
                        </li>
                        <li class="flex items-center text-gray-200">
                            <i class="fa-solid fa-check text-green-400 mr-3"></i>
                            <span>Персональные программы</span>
                        </li>
                    </ul>
                    <button onclick="showSubscribeModal()"
                           class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white text-center font-bold py-4 rounded-xl transition-all hover:scale-105">
                        От 299₽/месяц
                    </button>
                    <p class="text-center text-gray-300 text-sm mt-3">Отмена в любой момент</p>
                </div>
            {% endif %}
        </div>

        <!-- Комментарии (только для бесплатных видео с разрешенными комментариями) -->
{% if video.is_free and video.allow_comments %}
<div class="lg:w-1/3">
    <!-- КОММЕНТАРИИ - в правой колонке, выше всего -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl sticky top-24 h-fit">
        <!-- Заголовок -->
        <h2 class="text-xl font-bold text-white mb-4">Комментарии</h2>

        <!-- Форма комментария -->
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_video_comment' video.id %}" class="mb-6">
            {% csrf_token %}
            <input type="hidden" name="parent_id" id="parent_id" value="">
            <div class="mb-3">
                <textarea name="text" id="id_text" rows="2"
                          class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-white text-sm"
                          placeholder="Напишите комментарий..." maxlength="500" required></textarea>
            </div>
            <div class="flex justify-end">
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-1.5 rounded text-sm font-semibold">
                    Отправить
                </button>
            </div>
        </form>
        {% else %}
        <div class="bg-gray-900 rounded-lg p-3 mb-6 text-center">
            <p class="text-gray-300 text-sm mb-2">Войдите, чтобы комментировать</p>
            <button hx-get="/accounts/login/" hx-target="#modal-content" hx-swap="innerHTML"
                    class="inline-block bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                Войти
            </button>
        </div>
        {% endif %}

        <!-- Список комментариев (компактный) -->
        <div id="comments-list" class="max-h-[500px] overflow-y-auto pr-2">
            {% if comments %}
                <div class="space-y-4">
                    {% for comment in comments %}
                    <div class="pb-4 border-b border-gray-700 last:border-b-0" id="comment-{{ comment.id }}">
                        <div class="flex">
                            <!-- Аватар -->
                            <div class="flex-shrink-0 mr-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full flex items-center justify-center">
                                    <span class="text-white text-xs font-semibold">
                                        {{ comment.user.username|slice:":1"|upper }}
                                    </span>
                                </div>
                            </div>

                            <!-- Контент -->
                            <div class="flex-1">
                                <!-- Заголовок -->
                                <div class="mb-1">
                                    <span class="font-semibold text-white text-sm">{{ comment.user.username }}</span>
                                    <span class="text-gray-500 text-xs ml-2">{{ comment.created_at|timesince }} назад</span>
                                </div>

                                <!-- Текст (обрезанный) -->
                                <p class="text-gray-300 text-sm whitespace-pre-line break-words">
                                    {% if comment.text|length > 150 %}
                                        {{ comment.text|slice:":150" }}...
                                        <button onclick="showFullComment({{ comment.id }})"
                                                class="text-purple-400 hover:text-purple-300 text-xs ml-1">
                                            далее
                                        </button>
                                    {% else %}
                                        {{ comment.text }}
                                    {% endif %}
                                </p>

                                <!-- Кнопка ответа (если не свой комментарий) -->
                                {% if user.is_authenticated and user != comment.user %}
                                <button onclick="replyToComment({{ comment.id }}, '{{ comment.user.username }}')"
                                        class="text-gray-400 hover:text-purple-400 text-xs mt-1 flex items-center">
                                    <i class="fa-solid fa-reply mr-1"></i>
                                    Ответить
                                </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Показать ответы если есть -->
                        {% with reply_count=comment.replies_count %}
                        {% if reply_count > 0 %}
                        <div class="mt-2 ml-11">
                            <button onclick="toggleCommentReplies({{ comment.id }})"
                                    id="toggle-replies-{{ comment.id }}"
                                    class="text-purple-400 hover:text-purple-300 text-xs flex items-center">
                                <i class="fa-solid fa-chevron-down mr-1 text-xs" id="icon-replies-{{ comment.id }}"></i>
                                {{ reply_count }} ответов
                            </button>

                            <!-- Ответы (скрыты) -->
                            <div id="replies-{{ comment.id }}" class="mt-2 space-y-2 hidden">
                                {% for reply in comment.get_replies %}
                                <div class="flex">
                                    <div class="flex-shrink-0 mr-2">
                                        <div class="w-6 h-6 bg-gray-700 rounded-full flex items-center justify-center">
                                            <span class="text-gray-400 text-xs">
                                                {{ reply.user.username|slice:":1"|upper }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="mb-1">
                                            <span class="font-medium text-white text-xs">{{ reply.user.username }}</span>
                                            <span class="text-gray-500 text-xs ml-1">{{ reply.created_at|timesince }} назад</span>
                                        </div>
                                        <p class="text-gray-300 text-xs">{{ reply.text|truncatechars:100 }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-6 text-gray-500">
                    <i class="fa-solid fa-comment-slash text-2xl mb-2"></i>
                    <p class="text-sm">Пока нет комментариев</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

    </div>
</div>

<!-- Модальное окно подписки -->
<div id="subscribe-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
    <div class="fixed inset-0 bg-black bg-opacity-80" onclick="hideSubscribeModal()"></div>
    <div class="relative bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl shadow-2xl max-w-2xl w-full mx-4 p-0 overflow-hidden">
        <button onclick="hideSubscribeModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">
            <i class="fa-solid fa-times"></i>
        </button>

        <div class="p-8 md:p-12">
            <div class="text-center mb-8">
                <i class="fa-solid fa-crown text-5xl text-yellow-400 mb-4"></i>
                <h2 class="text-3xl font-bold text-white mb-2">Полный доступ ко всем тренировкам</h2>
                <p class="text-gray-300">Выберите подходящий тариф</p>
            </div>

            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-purple-500 transition-colors">
                    <h3 class="text-xl font-bold text-white mb-2">1 месяц</h3>
                    <div class="text-3xl font-bold text-white mb-4">299₽</div>
                    <p class="text-gray-400 text-sm mb-6">Идеально для знакомства</p>
                    <button onclick="subscribe(1)"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Выбрать
                    </button>
                </div>

                <div class="bg-gradient-to-br from-purple-900 to-pink-900 rounded-2xl p-6 border-2 border-purple-500 relative">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-1 rounded-full text-sm font-bold">
                        ВЫГОДА 20%
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">3 месяца</h3>
                    <div class="text-3xl font-bold text-white mb-1">717₽</div>
                    <div class="text-gray-300 text-sm mb-4 line-through">897₽</div>
                    <p class="text-gray-300 text-sm mb-6">Самый популярный вариант</p>
                    <button onclick="subscribe(3)"
                            class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white py-3 rounded-lg font-semibold transition-colors">
                        Выбрать
                    </button>
                </div>

                <div class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-purple-500 transition-colors">
                    <h3 class="text-xl font-bold text-white mb-2">12 месяцев</h3>
                    <div class="text-3xl font-bold text-white mb-1">2399₽</div>
                    <div class="text-gray-300 text-sm mb-4 line-through">3588₽</div>
                    <p class="text-gray-400 text-sm mb-6">Максимальная экономия</p>
                    <button onclick="subscribe(12)"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Выбрать
                    </button>
                </div>
            </div>

            <div class="bg-gray-800/50 rounded-xl p-6">
                <h4 class="text-lg font-semibold text-white mb-4">Что входит в подписку:</h4>
                <ul class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <li class="flex items-center text-gray-200">
                        <i class="fa-solid fa-check text-green-400 mr-3"></i>
                        <span>1000+ премиум видео</span>
                    </li>
                    <li class="flex items-center text-gray-200">
                        <i class="fa-solid fa-check text-green-400 mr-3"></i>
                        <span>Все категории тренировок</span>
                    </li>
                    <li class="flex items-center text-gray-200">
                        <i class="fa-solid fa-check text-green-400 mr-3"></i>
                        <span>Персональные программы</span>
                    </li>
                    <li class="flex items-center text-gray-200">
                        <i class="fa-solid fa-check text-green-400 mr-3"></i>
                        <span>Скачивание для оффлайн</span>
                    </li>
                    <li class="flex items-center text-gray-200">
                        <i class="fa-solid fa-check text-green-400 mr-3"></i>
                        <span>Без рекламы</span>
                    </li>
                    <li class="flex items-center text-gray-200">
                        <i class="fa-solid fa-check text-green-400 mr-3"></i>
                        <span>Новые видео каждую неделю</span>
                    </li>
                </ul>
            </div>

            <div class="text-center mt-6">
                <p class="text-gray-400 text-sm">Нажимая "Выбрать", вы соглашаетесь с <a href="/terms/" class="text-purple-400 hover:underline">Условиями использования</a></p>
            </div>
        </div>
    </div>
</div>

<script>
// Функция для ответа на комментарий
function replyToComment(commentId, username) {
    // Устанавливаем parent_id в форме
    const parentField = document.getElementById('parent_id');
    if (parentField) {
        parentField.value = commentId;
    }

    // Меняем placeholder
    const textarea = document.getElementById('id_text');
    if (textarea) {
        textarea.placeholder = `Ответ ${username}...`;
        textarea.focus();
        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Показываем уведомление
    showNotification(`Отвечаете ${username}`);
}

// Показать/скрыть ответы на комментарий
function toggleCommentReplies(commentId) {
    const repliesDiv = document.getElementById(`replies-${commentId}`);
    const icon = document.getElementById(`icon-replies-${commentId}`);

    if (repliesDiv && icon) {
        if (repliesDiv.classList.contains('hidden')) {
            // Показываем ответы
            repliesDiv.classList.remove('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            // Скрываем ответы
            repliesDiv.classList.add('hidden');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
}

// Показать полный комментарий
function showFullComment(commentId) {
    const commentElement = document.getElementById(`comment-${commentId}`);
    if (commentElement) {
        // Находим текст комментария
        const textElement = commentElement.querySelector('p');
        if (textElement) {
            // Если текст уже был сокращен
            if (textElement.innerHTML.includes('...')) {
                // Загружаем полный текст через AJAX
                fetch(`/comment/${commentId}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        textElement.innerHTML = data.text;
                    })
                    .catch(error => {
                        console.error('Error loading comment:', error);
                    });
            }
        }
    }
}

// Функция показа уведомления
function showNotification(message) {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 px-4 py-2 bg-purple-600 text-white rounded-lg shadow-lg text-sm animate-fade-in';
    notification.textContent = message;
    notification.id = 'temp-notification';

    // Удаляем старое уведомление если есть
    const oldNotification = document.getElementById('temp-notification');
    if (oldNotification) {
        oldNotification.remove();
    }

    document.body.appendChild(notification);

    // Автоматическое удаление через 3 секунды
    setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-y-[-20px]');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Показ/скрытие модалки подписки
function showSubscribeModal() {
    document.getElementById('subscribe-modal').classList.remove('hidden');
    document.getElementById('subscribe-modal').classList.add('flex');
}

function hideSubscribeModal() {
    document.getElementById('subscribe-modal').classList.remove('flex');
    document.getElementById('subscribe-modal').classList.add('hidden');
}

// Симуляция подписки
function subscribe(months) {
    const prices = {1: 299, 3: 717, 12: 2399};
    const price = prices[months];

    // Здесь будет интеграция с платежной системой
    alert(`Вы выбрали подписку на ${months} месяц(а/ев) за ${price}₽\n\nНа этом этапе произошла бы интеграция с платежной системой (ЮKassa, CloudPayments и т.д.)`);
    hideSubscribeModal();
}

// Функция для кнопки "Поделиться"
function shareVideo() {
    const url = window.location.href;
    const title = '{{ video.title }} - FitnessVideo';

    if (navigator.share) {
        // Используем Web Share API если поддерживается
        navigator.share({
            title: title,
            text: 'Посмотри это видео на FitnessVideo!',
            url: url,
        })
        .then(() => console.log('Успешно поделились'))
        .catch(error => console.log('Ошибка:', error));
    } else {
        // Копируем в буфер обмена
        navigator.clipboard.writeText(url)
            .then(() => {
                showNotification('Ссылка скопирована в буфер обмена!');
            })
            .catch(err => {
                console.error('Ошибка копирования:', err);
                // Показываем модалку с ссылкой
                showShareModal();
            });
    }
}

// Функция показа модалки с ссылкой
function showShareModal() {
    const url = window.location.href;
    const modalContent = document.getElementById('modal-content');

    if (modalContent) {
        modalContent.innerHTML = `
            <div class="p-6">
                <h3 class="text-xl font-bold text-white mb-4">Поделиться видео</h3>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2">Ссылка на видео:</label>
                    <div class="flex">
                        <input type="text" value="${url}"
                               class="flex-1 bg-gray-700 border border-gray-600 rounded-l-lg px-3 py-2 text-white text-sm"
                               readonly id="share-url">
                        <button onclick="copyShareUrl()"
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-r-lg">
                            Копировать
                        </button>
                    </div>
                </div>
                <div class="flex space-x-3 mb-4">
                    <a href="https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent('Посмотри это видео!')}"
                       target="_blank"
                       class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-center py-2 rounded-lg">
                        <i class="fab fa-telegram"></i>
                    </a>
                    <a href="https://vk.com/share.php?url=${encodeURIComponent(url)}"
                       target="_blank"
                       class="flex-1 bg-blue-700 hover:bg-blue-800 text-white text-center py-2 rounded-lg">
                        <i class="fab fa-vk"></i>
                    </a>
                    <a href="https://wa.me/?text=${encodeURIComponent('Посмотри это видео: ' + url)}"
                       target="_blank"
                       class="flex-1 bg-green-500 hover:bg-green-600 text-white text-center py-2 rounded-lg">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                </div>
                <button onclick="closeModal()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg">
                    Закрыть
                </button>
            </div>
        `;

        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal').classList.add('flex');
    }
}

// Функция копирования ссылки
function copyShareUrl() {
    const urlInput = document.getElementById('share-url');
    if (urlInput) {
        urlInput.select();
        document.execCommand('copy');
        showNotification('Ссылка скопирована!');
    }
}

// Функция для лайка/дислайка
function toggleLike(videoId) {
    // Проверка аутентификации
    const userAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};

    if (!userAuthenticated) {
        // Используем HTMX для загрузки формы логина
        fetch('/accounts/login/')
            .then(response => response.text())
            .then(html => {
                const modalContent = document.getElementById('modal-content');
                if (modalContent) {
                    modalContent.innerHTML = html;
                    document.getElementById('modal').classList.remove('hidden');
                    document.getElementById('modal').classList.add('flex');
                }
            });
        return;
    }

    const button = document.getElementById('like-button-header');
    const likeIcon = button.querySelector('i');

    fetch(`/video/${videoId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        // Обновляем кнопку в заголовке
        if (data.liked) {
            button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
            button.classList.add('bg-pink-600', 'hover:bg-pink-700');
            likeIcon.classList.remove('fa-regular');
            likeIcon.classList.add('fa-solid');
        } else {
            button.classList.remove('bg-pink-600', 'hover:bg-pink-700');
            button.classList.add('bg-gray-700', 'hover:bg-gray-600');
            likeIcon.classList.remove('fa-solid');
            likeIcon.classList.add('fa-regular');
        }

        showNotification(data.liked ? 'Видео понравилось!' : 'Лайк убран');
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ошибка при обработке лайка', 'error');
    });
}

// Обновляем кнопку "Поделиться" в заголовке
document.addEventListener('DOMContentLoaded', function() {
    const shareButton = document.querySelector('button:has(.fa-share)');
    if (shareButton) {
        shareButton.addEventListener('click', shareVideo);
    }

    // Закрытие модалки подписки по ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSubscribeModal();
        }
    });

    // Клик по затемненной области закрывает модалку
    const subscribeModal = document.getElementById('subscribe-modal');
    if (subscribeModal) {
        subscribeModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideSubscribeModal();
            }
        });
    }

    // Сброс формы комментариев при отправке
    const commentForm = document.querySelector('form[action*="add_video_comment"]');
    if (commentForm) {
        commentForm.addEventListener('submit', function() {
            setTimeout(() => {
                this.reset();
                const parentIdField = document.getElementById('parent_id');
                if (parentIdField) parentIdField.value = '';
                const textarea = document.getElementById('id_text');
                if (textarea) textarea.placeholder = 'Напишите комментарий...';
            }, 1000);
        });
    }

    // Восстановление времени просмотра видео
    const video = document.getElementById('main-video');
    if (video) {
        // Сохраняем время просмотра при уходе со страницы
        window.addEventListener('beforeunload', function() {
            if (video.currentTime > 10) {
                localStorage.setItem(`video_{{ video.id }}_time`, video.currentTime);
            }
        });

        // Восстанавливаем время просмотра
        const savedTime = localStorage.getItem(`video_{{ video.id }}_time`);
        if (savedTime && video.controls) {
            video.addEventListener('loadedmetadata', function() {
                video.currentTime = parseFloat(savedTime);
            });
        }
    }

    // Автоматически показывать ответы если есть упоминание в URL
    const urlHash = window.location.hash;
    if (urlHash.startsWith('#comment-')) {
        const commentId = urlHash.replace('#comment-', '');
        const commentElement = document.getElementById(`comment-${commentId}`);

        if (commentElement) {
            setTimeout(() => {
                commentElement.scrollIntoView({ behavior: 'smooth' });

                // Добавляем подсветку
                commentElement.classList.add('bg-gray-900/30', 'rounded-lg', 'p-4');
                setTimeout(() => {
                    commentElement.classList.remove('bg-gray-900/30', 'rounded-lg', 'p-4');
                }, 3000);
            }, 500);
        }
    }

    // Показываем ответы для комментариев с параметром show_replies
    const urlParams = new URLSearchParams(window.location.search);
    const showReplies = urlParams.get('show_replies');
    if (showReplies) {
        setTimeout(() => {
            toggleCommentReplies(showReplies);
        }, 1000);
    }
});
</script>
{% endblock %}