{% load static %}

<div class="banner-slider relative overflow-hidden rounded-2xl shadow-2xl mb-8 mx-4 lg:mx-0 group"
     style="min-height: 300px; max-height: 600px; height: 400px;">

  {% for banner in active_banners %}

  <!-- Основной контейнер баннера -->
  <div class="banner-container absolute inset-0 w-full h-full"
       {% if banner.is_clickable and not banner.show_button %}onclick="window.location.href='{{ banner.click_link|default:'/' }}'"{% endif %}
       style="
         {% if not forloop.first %}
           opacity: 0; pointer-events: none; z-index: 0;
         {% else %}
           opacity: 1; pointer-events: auto; z-index: 10;
         {% endif %}
         transition: opacity 0.5s ease;
       ">

    <div class="banner-slide absolute inset-0 w-full h-full transition-all duration-1000 ease-in-out"
         data-index="{{ forloop.counter0 }}"
         data-banner-id="{{ banner.id }}"
         data-banner-link="{{ banner.click_link|default:'/' }}"
         style="
           {% if banner.is_clickable and banner.show_button %}
             cursor: default;
           {% elif banner.is_clickable %}
             cursor: pointer;
           {% endif %}
         ">

      <!-- Изображение -->
      <picture class="absolute inset-0 w-full h-full">
        <source media="(max-width: 768px)"
                srcset="{% if banner.image_mobile %}{{ banner.image_mobile.url }}{% else %}{{ banner.image.url }}{% endif %}">
        <img src="{{ banner.image.url }}"
             alt="{{ banner.title }}"
             class="w-full h-full object-cover transition-transform duration-1000 ease-in-out"
             loading="lazy"
             width="1920"
             height="600">
      </picture>

      <!-- Затемнение -->
      <div class="absolute inset-0 w-full h-full transition-all duration-700" style="background: {{ banner.overlay_color }};"></div>

      <!-- Контент -->
      <div class="relative h-full flex items-center px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16"
           style="justify-content:
                  {% if banner.text_position == 'left' %}flex-start
                  {% elif banner.text_position == 'right' %}flex-end
                  {% else %}center{% endif %};">

        <div class="max-w-2xl text-{% if banner.text_position == 'center' %}center{% else %}left{% endif %} transform transition-all duration-700 ease-out"
             style="color: {{ banner.text_color }};">

          <!-- Заголовок -->
          {% if banner.show_title %}
          <h2 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl font-bold mb-2 md:mb-4 leading-tight transition-all duration-500">
            {{ banner.title }}
          </h2>
          {% endif %}

          <!-- Подзаголовок -->
          {% if banner.show_subtitle and banner.subtitle %}
          <p class="text-sm sm:text-base md:text-lg lg:text-xl xl:text-2xl mb-4 md:mb-6 lg:mb-8 opacity-90 leading-relaxed transition-all duration-500 delay-100">
            {{ banner.subtitle }}
          </p>
          {% endif %}

          <!-- Кнопка (с разными вариантами отображения) -->
          {% if banner.button_text and banner.show_button %}
          <div class="banner-button-container transition-all duration-300
                     {% if banner.button_on_hover %}hover-button{% endif %}">
            <a href="{{ banner.button_link }}"
               class="inline-flex items-center justify-center bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700
                      text-white font-bold rounded-full
                      transition-all duration-300 transform hover:scale-105 hover:shadow-2xl active:scale-95
                      shadow-lg
                      px-4 py-2 text-sm
                      sm:px-5 sm:py-2.5 sm:text-base
                      md:px-6 md:py-3 md:text-lg
                      lg:px-8 lg:py-4 lg:text-xl
                      whitespace-normal sm:whitespace-nowrap
                      max-w-full
                      text-center"
               {% if banner.is_clickable and banner.show_button %}onclick="event.stopPropagation();"{% endif %}>
              <span class="mx-1">{{ banner.button_text }}</span>
              <i class="fa-solid fa-arrow-right ml-2 flex-shrink-0"></i>
            </a>
          </div>
          {% endif %}

        </div>
      </div>

      <!-- Индикатор кликабельности (только для десктопа) -->
      {% if banner.is_clickable and not banner.show_button %}
      <div class="absolute bottom-6 right-6 hidden lg:block opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
        <div class="bg-black/50 text-white text-xs px-3 py-1 rounded-full backdrop-blur-sm">
          <i class="fa-solid fa-up-right-from-square mr-1"></i>
          Кликните для перехода
        </div>
      </div>
      {% endif %}

    </div>
  </div>
  {% endfor %}

  <!-- Индикаторы слайдов -->
  {% if active_banners|length > 1 %}
  <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-30">
    {% for banner in active_banners %}
    <button class="banner-indicator w-3 h-3 rounded-full transition-all duration-300
                   {% if forloop.first %}bg-white scale-125 shadow-md{% else %}bg-white/50 hover:bg-white/70{% endif %}"
            data-index="{{ forloop.counter0 }}"
            aria-label="Показать баннер {{ forloop.counter }}">
    </button>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Кнопки навигации -->
  {% if active_banners|length > 1 %}
  <button class="banner-prev absolute left-2 sm:left-4 top-1/2 transform -translate-y-1/2
                 bg-black/30 hover:bg-black/50 active:bg-black/60 text-white
                 p-2 sm:p-3 rounded-full
                 transition-all duration-300 opacity-0 group-hover:opacity-100 hidden sm:block z-30
                 active:scale-95"
          aria-label="Предыдущий баннер">
    <i class="fa-solid fa-chevron-left text-lg sm:text-xl"></i>
  </button>

  <button class="banner-next absolute right-2 sm:right-4 top-1/2 transform -translate-y-1/2
                 bg-black/30 hover:bg-black/50 active:bg-black/60 text-white
                 p-2 sm:p-3 rounded-full
                 transition-all duration-300 opacity-0 group-hover:opacity-100 hidden sm:block z-30
                 active:scale-95"
          aria-label="Следующий баннер">
    <i class="fa-solid fa-chevron-right text-lg sm:text-xl"></i>
  </button>
  {% endif %}
</div>

<style>
/* =================== ОСНОВНЫЕ СТИЛИ БАННЕРА =================== */
.banner-slider {
    touch-action: pan-y pinch-zoom;
    user-select: none;
    position: relative;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
}

.banner-container {
    position: absolute !important;
    inset: 0 !important;
    width: 100% !important;
    height: 100% !important;
    transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.banner-slide {
    position: absolute !important;
    inset: 0 !important;
    width: 100% !important;
    height: 100% !important;
    transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 1s cubic-bezier(0.4, 0, 0.2, 1) !important;
    will-change: transform, opacity;
    transform-style: preserve-3d;
    backface-visibility: hidden;
}

/* =================== КНОПКА ПРИ НАВЕДЕНИИ - РАБОЧЕЕ РЕШЕНИЕ =================== */
/* 1. Кнопка скрыта если есть класс hover-button */
.banner-button-container.hover-button {
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
}

/* 2. При наведении на весь слайдер показываем кнопку */
.banner-slider:hover .banner-button-container.hover-button {
    opacity: 1 !important;
}

/* 3. Для гарантии работы с group классом */
.banner-slider.group:hover .banner-button-container.hover-button {
    opacity: 1 !important;
}

/* =================== АНИМАЦИИ И ТРАНСФОРМАЦИИ =================== */
.banner-slide.translate-x-0 {
    transform: translateX(0) !important;
}

.banner-slide.translate-x-full {
    transform: translateX(100%) !important;
}

.banner-slide.-translate-x-full {
    transform: translateX(-100%) !important;
}

/* =================== ИНДИКАТОРЫ И КНОПКИ =================== */
.banner-indicator {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    cursor: pointer;
    transform-origin: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.banner-indicator:hover {
    transform: scale(1.3) !important;
    background-color: rgba(255, 255, 255, 0.9) !important;
}

.banner-indicator.bg-white {
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5), 0 2px 8px rgba(0,0,0,0.3) !important;
}

.banner-prev, .banner-next {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    transform-origin: center;
    backdrop-filter: blur(4px);
    cursor: pointer;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.banner-slider:hover .banner-prev,
.banner-slider:hover .banner-next {
    opacity: 1 !important;
}

/* =================== АДАПТИВНОСТЬ =================== */
@media (max-width: 640px) {
    .banner-slider {
        min-height: 250px !important;
        max-height: 400px !important;
        height: 300px !important;
        border-radius: 1rem !important;
        margin: 0 0.5rem 1rem !important;
    }

    .banner-slider .banner-slide h2 {
        font-size: 1.25rem !important;
        margin-bottom: 0.25rem !important;
        line-height: 1.1 !important;
        padding: 0 0.5rem;
    }

    .banner-slider .banner-slide p {
        font-size: 0.75rem !important;
        margin-bottom: 0.75rem !important;
        line-height: 1.2 !important;
        padding: 0 0.5rem;
        -webkit-line-clamp: 2;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .banner-slider .banner-slide a {
        font-size: 0.75rem !important;
        padding: 0.5rem 1rem !important;
        margin: 0 auto !important;
        white-space: normal !important;
        text-align: center !important;
        line-height: 1.2 !important;
    }

    .banner-indicator {
        width: 8px !important;
        height: 8px !important;
    }

    /* На мобильных кнопка всегда видна */
    .banner-button-container.hover-button {
        opacity: 1 !important;
    }
}

/* =================== ЭФФЕКТЫ ПРИ НАВЕДЕНИИ =================== */
.banner-slide img {
    transition: transform 8s cubic-bezier(0.2, 0, 0.2, 1) !important;
    transform-origin: center;
}

.banner-slider:hover .banner-slide img {
    transform: scale(1.05) !important;
}

/* =================== МОБИЛЬНЫЕ УСТРОЙСТВА =================== */
@media (hover: none) and (pointer: coarse) {
    .banner-slider .banner-prev,
    .banner-slider .banner-next {
        display: none !important;
    }

    .banner-slider:hover .banner-slide img {
        transform: none !important;
    }

    /* На мобильных кнопка всегда видна */
    .banner-button-container.hover-button {
        opacity: 1 !important;
    }
}

/* =================== ЗАГРУЗКА И ПРОИЗВОДИТЕЛЬНОСТЬ =================== */
@media (prefers-reduced-motion: reduce) {
    .banner-slide,
    .banner-container,
    .banner-indicator,
    .banner-prev,
    .banner-next {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
    }
}
</style>

<script>
(function() {
    'use strict';

    // Конфигурация
    const CONFIG = {
        intervalTime: 5000,
        swipeThreshold: 50,
        transitionDuration: 1000
    };

    // Состояние
    let currentBanner = 0;
    let bannerContainers = [];
    let bannerSlides = [];
    let bannerIndicators = [];
    let autoPlayInterval = null;
    let sliderElement = null;
    let isAnimating = false;

    // Для свайпа
    let touchStartX = 0;
    let touchEndX = 0;
    let isSwiping = false;

    // Получение DOM элементов
    function getElements() {
        sliderElement = document.querySelector('.banner-slider');
        bannerContainers = Array.from(document.querySelectorAll('.banner-container'));
        bannerSlides = Array.from(document.querySelectorAll('.banner-slide'));
        bannerIndicators = Array.from(document.querySelectorAll('.banner-indicator'));
    }

    // Плавное переключение баннеров
    function showBanner(index) {
        if (isAnimating || index < 0 || index >= bannerContainers.length) return;

        isAnimating = true;
        const prevIndex = currentBanner;
        currentBanner = index;

        // Определяем направление анимации
        const direction = index > prevIndex ? 'translate-x-full' : '-translate-x-full';
        const reverseDirection = index > prevIndex ? '-translate-x-full' : 'translate-x-full';

        // Скрываем предыдущий контейнер
        if (bannerContainers[prevIndex]) {
            bannerContainers[prevIndex].style.opacity = '0';
            bannerContainers[prevIndex].style.pointerEvents = 'none';
            bannerContainers[prevIndex].style.zIndex = '0';

            // Анимация слайда
            bannerSlides[prevIndex].classList.remove('translate-x-0', 'opacity-100', 'z-10');
            bannerSlides[prevIndex].classList.add('opacity-0', 'pointer-events-none', 'z-0', direction);
        }

        // Показываем новый контейнер
        if (bannerContainers[index]) {
            bannerContainers[index].style.opacity = '1';
            bannerContainers[index].style.pointerEvents = 'auto';
            bannerContainers[index].style.zIndex = '10';

            // Анимация слайда
            bannerSlides[index].classList.remove('translate-x-0', 'opacity-0', 'pointer-events-none', 'z-0');
            bannerSlides[index].classList.add(reverseDirection, 'opacity-100', 'z-10');

            // Запускаем анимацию появления
            requestAnimationFrame(() => {
                bannerSlides[index].classList.remove(direction, reverseDirection);
                bannerSlides[index].classList.add('translate-x-0');
            });
        }

        // Обновление индикаторов
        updateIndicators(prevIndex, index);

        // Сброс автоплея
        resetAutoPlay();

        // Разблокировка анимации
        setTimeout(() => {
            isAnimating = false;
        }, CONFIG.transitionDuration);
    }

    // Обновление индикаторов
    function updateIndicators(prevIndex, currentIndex) {
        if (prevIndex >= 0 && bannerIndicators[prevIndex]) {
            bannerIndicators[prevIndex].classList.remove('bg-white', 'scale-125', 'shadow-md');
            bannerIndicators[prevIndex].classList.add('bg-white/50');
        }

        if (currentIndex >= 0 && bannerIndicators[currentIndex]) {
            bannerIndicators[currentIndex].classList.remove('bg-white/50');
            bannerIndicators[currentIndex].classList.add('bg-white', 'scale-125', 'shadow-md');
        }
    }

    // Следующий баннер
    function nextBanner() {
        if (isAnimating || bannerContainers.length <= 1) return;
        const nextIndex = (currentBanner + 1) % bannerContainers.length;
        showBanner(nextIndex);
    }

    // Предыдущий баннер
    function prevBanner() {
        if (isAnimating || bannerContainers.length <= 1) return;
        const prevIndex = (currentBanner - 1 + bannerContainers.length) % bannerContainers.length;
        showBanner(prevIndex);
    }

    // Автоплей
    function startAutoPlay() {
        if (bannerContainers.length > 1 && !autoPlayInterval) {
            autoPlayInterval = setInterval(nextBanner, CONFIG.intervalTime);
        }
    }

    function stopAutoPlay() {
        if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
        }
    }

    function resetAutoPlay() {
        stopAutoPlay();
        setTimeout(startAutoPlay, 3000);
    }

    // Обработка свайпов
    function handleTouchStart(e) {
        if (bannerContainers.length <= 1) return;
        touchStartX = e.touches[0].clientX;
        isSwiping = true;
        stopAutoPlay();
    }

    function handleTouchMove(e) {
        if (!isSwiping) return;
        touchEndX = e.touches[0].clientX;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > 10 && bannerSlides[currentBanner]) {
            const translateX = Math.max(-100, Math.min(100, diff / 10));
            bannerSlides[currentBanner].style.transform = `translateX(${translateX}%)`;
        }
    }

    function handleTouchEnd(e) {
        if (!isSwiping) return;

        isSwiping = false;
        touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;

        if (bannerSlides[currentBanner]) {
            bannerSlides[currentBanner].style.transform = '';
        }

        if (Math.abs(diff) > CONFIG.swipeThreshold) {
            if (diff > 0) {
                nextBanner();
            } else {
                prevBanner();
            }
        }

        setTimeout(startAutoPlay, 3000);
    }

    // Обработка клика по баннеру
    function setupClickHandlers() {
        document.querySelectorAll('.banner-container').forEach(container => {
            container.addEventListener('click', function(e) {
                // Проверяем, был ли клик по кнопке
                if (e.target.closest('a') || e.target.tagName === 'A') {
                    return;
                }

                // Получаем баннер
                const bannerSlide = this.querySelector('.banner-slide');
                if (bannerSlide && bannerSlide.style.cursor === 'pointer') {
                    const link = bannerSlide.getAttribute('data-banner-link') || '/';
                    window.location.href = link;
                }
            });
        });
    }

    // Инициализация
    function initBannerSlider() {
        getElements();

        if (bannerContainers.length === 0) return;

        // Очистка старых обработчиков
        if (sliderElement) {
            sliderElement.removeEventListener('touchstart', handleTouchStart);
            sliderElement.removeEventListener('touchmove', handleTouchMove);
            sliderElement.removeEventListener('touchend', handleTouchEnd);
            sliderElement.removeEventListener('mouseenter', stopAutoPlay);
            sliderElement.removeEventListener('mouseleave', startAutoPlay);
        }

        // Добавляем обработчики если больше одного баннера
        if (bannerContainers.length > 1) {
            if (sliderElement) {
                sliderElement.addEventListener('touchstart', handleTouchStart, { passive: true });
                sliderElement.addEventListener('touchmove', handleTouchMove, { passive: true });
                sliderElement.addEventListener('touchend', handleTouchEnd, { passive: true });

                sliderElement.addEventListener('mouseenter', stopAutoPlay);
                sliderElement.addEventListener('mouseleave', () => setTimeout(startAutoPlay, 1000));

                const prevBtn = sliderElement.querySelector('.banner-prev');
                const nextBtn = sliderElement.querySelector('.banner-next');

                if (prevBtn) prevBtn.onclick = prevBanner;
                if (nextBtn) nextBtn.onclick = nextBanner;
            }

            // Индикаторы
            bannerIndicators.forEach((indicator, index) => {
                indicator.onclick = () => showBanner(index);
            });

            // Запускаем автоплей
            startAutoPlay();
        }

        // Настройка кликов
        setupClickHandlers();

        // Убедимся что правильный баннер активен
        showBanner(currentBanner);
    }

    // События
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initBannerSlider, 100);
    });

    // Для HTMX
    document.addEventListener('htmx:afterSwap', () => {
        setTimeout(initBannerSlider, 300);
    });

    document.addEventListener('htmx:beforeSwap', stopAutoPlay);

})();
</script>