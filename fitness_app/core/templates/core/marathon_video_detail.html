{% extends 'core/base.html' %}

{% block title %}{{ video.title }} - {{ marathon.title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Хлебные крошки -->
    <nav class="mb-8 text-sm text-gray-400 flex items-center">
        <a href="{% url 'marathon_list' %}" class="hover:text-purple-400 transition">Марафоны</a>
        <i class="fa-solid fa-chevron-right mx-2 text-xs"></i>
        <a href="{{ marathon.get_absolute_url }}" class="hover:text-purple-400 transition">{{ marathon.title|truncatechars:30 }}</a>
        <i class="fa-solid fa-chevron-right mx-2 text-xs"></i>
        <span class="text-white">{{ video.title|truncatechars:30 }}</span>
    </nav>

    <!-- Кнопка "Назад к марафону" -->
    <div class="mb-6">
        <a href="{{ marathon.get_absolute_url }}"
           class="inline-flex items-center text-purple-400 hover:text-purple-300 transition">
            <i class="fa-solid fa-arrow-left mr-2"></i>
            Вернуться к марафону
        </a>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Основной контент -->
        <div class="lg:w-2/3">
            <!-- Видеоплеер -->
            <div class="bg-black rounded-2xl overflow-hidden shadow-2xl mb-8">
                <video id="main-video"
                       class="w-full"
                       controls
                       poster="{% if video.thumbnail %}{{ video.thumbnail.url }}{% endif %}">
                    <source src="{{ video.file.url }}" type="video/mp4">
                    Ваш браузер не поддерживает видео.
                </video>
            </div>

        <!-- Боковая панель -->
        <div class="lg:w-1/3">
            <!-- Похожие видео в марафоне -->
            {% if similar_videos %}
            <div class="bg-gray-800 rounded-2xl p-6 mb-6">
                <h2 class="text-xl font-bold text-white mb-4">Другие уроки марафона</h2>
                <div class="space-y-3">
                    {% for similar in similar_videos %}
                    <a href="{{ similar.get_absolute_url }}"
                       class="flex items-center bg-gray-900 hover:bg-gray-700 rounded-xl p-3 transition-colors group">
                        <div class="relative w-20 h-12 flex-shrink-0 rounded overflow-hidden">
                            {% if similar.thumbnail %}
                                <img src="{{ similar.thumbnail.url }}"
                                     alt="{{ similar.title }}"
                                     class="w-full h-full object-cover">
                            {% else %}
                                <div class="w-full h-full bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center">
                                    <i class="fa-solid fa-play text-gray-600"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="ml-4 flex-1 min-w-0">
                            <h4 class="font-medium text-white group-hover:text-purple-400 text-sm line-clamp-2 break-words">{{ similar.title }}</h4>
                            <div class="flex items-center text-gray-400 text-xs mt-1">
<!--                                <span>Урок {{ similar.order|default:"?" }}</span>-->
                                <span class="mx-2">•</span>
                                <span>{{ similar.get_duration_display }}</span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>

                <!-- Кнопка "Все видео марафона" -->
                <a href="{{ marathon.get_absolute_url }}#videos"
                   class="block w-full mt-4 text-center bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition-colors text-sm">
                    <i class="fa-solid fa-list mr-2"></i>
                    Все видео марафона
                </a>
            </div>
            {% endif %}

            <!-- Информация о марафоне -->
            <div class="bg-gradient-to-br from-purple-900 to-pink-900 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">Это видео из марафона</h3>

                <div class="mb-4">
                    <h4 class="font-semibold text-white mb-2 line-clamp-2 break-words">{{ marathon.title }}</h4>
                    {% if marathon.short_description %}
                    <p class="text-gray-200 text-sm line-clamp-3">{{ marathon.short_description }}</p>
                    {% endif %}
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="text-center p-3 bg-purple-800/50 rounded-lg">
                        <div class="text-lg font-bold text-white">{{ marathon_videos_count }}</div>
                        <div class="text-purple-200 text-xs">видео</div>
                    </div>

                    {% if marathon.get_duration_minutes %}
                    <div class="text-center p-3 bg-purple-800/50 rounded-lg">
                        <div class="text-lg font-bold text-white">{{ marathon.get_duration_minutes }}</div>
                        <div class="text-purple-200 text-xs">минут</div>
                    </div>
                    {% endif %}
                </div>

                <a href="{{ marathon.get_absolute_url }}"
                   class="block w-full bg-white text-purple-900 hover:bg-gray-100 text-center font-bold py-3 rounded-lg transition-colors">
                    <i class="fa-solid fa-fire mr-2"></i>
                    Перейти к марафону
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Сохранение времени просмотра
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('main-video');
    if (video) {
        // Восстанавливаем время просмотра
        const savedTime = localStorage.getItem(`marathon_video_{{ video.id }}_time`);
        if (savedTime) {
            video.addEventListener('loadedmetadata', function() {
                video.currentTime = parseFloat(savedTime);
            });
        }

        // Сохраняем время при уходе со страницы
        window.addEventListener('beforeunload', function() {
            if (video.currentTime > 10) {
                localStorage.setItem(`marathon_video_{{ video.id }}_time`, video.currentTime);
            }
        });

        // Увеличиваем просмотры через 30 секунд просмотра
        let viewCounted = false;
        video.addEventListener('timeupdate', function() {
            if (!viewCounted && video.currentTime > 30) {
                // Отправляем запрос на увеличение просмотров
                fetch(`{{ video.get_absolute_url }}`, {
                    method: 'HEAD'
                });
                viewCounted = true;
            }
        });
    }
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Перенос длинных слов */
.break-words {
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
}

/* Ограничение строк */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Кастомный скроллбар для описания */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}
</style>
{% endblock %}