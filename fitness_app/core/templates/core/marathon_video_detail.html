{% extends 'core/base.html' %}

{% block title %}{{ video.title }} - {{ marathon.title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Хлебные крошки -->
    <nav class="mb-8 text-sm text-gray-400 flex items-center flex-wrap">
        <a href="{% url 'marathon_list' %}" class="hover:text-purple-400 transition">Марафоны</a>
        <i class="fa-solid fa-chevron-right mx-2 text-xs"></i>
        <a href="{{ marathon.get_absolute_url }}" class="hover:text-purple-400 transition">{{ marathon.title|truncatechars:30 }}</a>
        <i class="fa-solid fa-chevron-right mx-2 text-xs"></i>
        <span class="text-white">{{ video.title|truncatechars:30 }}</span>
    </nav>

    <!-- Кнопка "Назад к марафону" -->
    <div class="mb-6">
        <a href="{{ marathon.get_absolute_url }}"
           class="inline-flex items-center text-purple-400 hover:text-purple-300 transition">
            <i class="fa-solid fa-arrow-left mr-2"></i>
            Вернуться к марафону
        </a>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Основной контент -->
        <div class="lg:w-2/3">
            <!-- Видеоплеер -->
            <div class="bg-black rounded-2xl overflow-hidden shadow-2xl mb-8">
                <video id="main-video"
                       class="w-full"
                       controls
                       poster="{% if video.thumbnail %}{{ video.thumbnail.url }}{% endif %}">
                    <source src="{{ video.file.url }}" type="video/mp4">
                    Ваш браузер не поддерживает видео.
                </video>
            </div>
        </div>

        <!-- Боковая панель -->
        <div class="lg:w-1/3">
            <!-- Другие видео марафона -->
            {% if similar_videos %}
            <div class="bg-gray-800 rounded-2xl p-6 shadow-xl mb-6 sticky top-24">
                <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fa-solid fa-list mr-3 text-purple-400"></i>
                    Другие уроки марафона
                </h2>

                <div class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                    {% for similar in similar_videos %}
                    {% with similar_order=similar.order|default:forloop.counter %}
                    <a href="{{ similar.get_absolute_url }}"
                       class="flex items-center bg-gray-900 hover:bg-gray-700 rounded-xl p-3 transition-colors group {% if similar.id == video.id %}ring-2 ring-purple-500 bg-gray-700{% endif %}">
                        <div class="relative w-20 h-12 flex-shrink-0 rounded overflow-hidden">
                            {% if similar.thumbnail %}
                                <img src="{{ similar.thumbnail.url }}"
                                     alt="{{ similar.title }}"
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform">
                            {% else %}
                                <div class="w-full h-full bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center">
                                    <i class="fa-solid fa-play text-gray-600"></i>
                                </div>
                            {% endif %}

                            <!-- Индикатор просмотренного (можно добавить позже) -->
                            <div class="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full hidden"></div>
                        </div>

                        <div class="ml-4 flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="font-medium text-white group-hover:text-purple-400 text-sm line-clamp-2 break-words">
                                    {{ similar.title }}
                                </h4>
                                {% if similar.id == video.id %}
                                <span class="ml-2 text-purple-400 text-xs whitespace-nowrap">
                                    <i class="fa-solid fa-play"></i>
                                </span>
                                {% endif %}
                            </div>
                            <div class="flex items-center text-gray-400 text-xs mt-1">
                                <!-- Номер урока из поля order, если нет order - используем счетчик цикла -->
                                <span>Урок
                                    {% if similar.order %}
                                        {{ similar.order }}
                                    {% else %}
                                        {{ forloop.counter }}
                                    {% endif %}
                                </span>
                                <span class="mx-2">•</span>
                                <span>{{ similar.get_duration_display|default:"—" }}</span>
                            </div>
                        </div>
                    </a>
                    {% endwith %}
                    {% endfor %}
                </div>

                <!-- Кнопка "Все видео марафона" -->
                <a href="{{ marathon.get_absolute_url }}#videos"
                   class="block w-full mt-5 text-center bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg transition-colors text-sm font-semibold">
                    <i class="fa-solid fa-grid-2 mr-2"></i>
                    Все видео марафона
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Сохранение времени просмотра
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('main-video');
    if (video) {
        // Восстанавливаем время просмотра
        const savedTime = localStorage.getItem(`marathon_video_{{ video.id }}_time`);
        if (savedTime) {
            video.addEventListener('loadedmetadata', function() {
                video.currentTime = parseFloat(savedTime);
            });
        }

        // Сохраняем время при уходе со страницы
        window.addEventListener('beforeunload', function() {
            if (video.currentTime > 10) {
                localStorage.setItem(`marathon_video_{{ video.id }}_time`, video.currentTime);
            }
        });

        // Увеличиваем просмотры через 30 секунд просмотра
        let viewCounted = false;
        video.addEventListener('timeupdate', function() {
            if (!viewCounted && video.currentTime > 30) {
                // Отправляем запрос на увеличение просмотров
                fetch(`{{ video.get_absolute_url }}`, {
                    method: 'HEAD'
                });
                viewCounted = true;
            }
        });
    }
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Перенос длинных слов */
.break-words {
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
}

/* Кастомный скроллбар для списка видео */
.max-h-\[500px\]::-webkit-scrollbar {
    width: 4px;
}

.max-h-\[500px\]::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 2px;
}

.max-h-\[500px\]::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.3);
    border-radius: 2px;
}

.max-h-\[500px\]::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 92, 246, 0.5);
}

/* Анимация для текущего видео */
.ring-2 {
    box-shadow: 0 0 0 2px rgb(139, 92, 246);
}
</style>
{% endblock %}